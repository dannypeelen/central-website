import { LogLevel } from '../printer/printer.js';
import { printer as globalPrinter, minimumLogLevel } from '../printer.js';
import { format } from '../format/format.js';
import { CfnDeploymentProgressLogger, } from './cfn-deployment-progress/cfn_deployment_progress_logger.js';
import { WriteStream } from 'node:tty';
import { RewritableBlock } from './cfn-deployment-progress/rewritable_block.js';
import { EOL } from 'node:os';
/**
 * Amplify events logger class. Implements several loggers that connect
 * to the amplify_io_event_bridge for showing relevant information to customers
 */
export class AmplifyEventLogger {
    printer;
    amplifyIOEventsBridgeSingletonFactory;
    cfnDeploymentProgressLogger;
    outputs = {};
    /**
     * a logger instance to be used for CDK events
     */
    constructor(printer = globalPrinter, amplifyIOEventsBridgeSingletonFactory) {
        this.printer = printer;
        this.amplifyIOEventsBridgeSingletonFactory = amplifyIOEventsBridgeSingletonFactory;
    }
    getEventLoggers = () => {
        if (minimumLogLevel === LogLevel.DEBUG) {
            return {
                notify: [this.debug],
            };
        }
        const loggers = [this.amplifyNotifications, this.cdkDeploymentProgress];
        if (this.printer.ttyEnabled) {
            loggers.push(this.fancyCfnDeploymentProgress);
        }
        else {
            loggers.push(this.nonTtyCfnDeploymentProgress);
        }
        return {
            notify: loggers,
        };
    };
    /**
     * Log debug messages
     */
    debug = (msg) => {
        if (msg.level === 'trace' || msg.level === 'debug') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'sdkLevel' in msg.data &&
                'content' in msg.data &&
                Array.isArray(msg.data.content)) {
                msg.data.content.forEach((trace) => {
                    this.printer.log(`AWS SDK Call ${trace.clientName}: ${trace.commandName}`, LogLevel.DEBUG);
                });
            }
            else {
                this.printer.log(`[${msg.action}: ${msg.code}] ${msg.message}`, LogLevel.DEBUG);
            }
        }
        else {
            this.printer.log(`[${format.color(`${msg.action}: ${msg.code}`, msg.level === 'error'
                ? 'Red'
                : msg.level === 'warn'
                    ? 'Yellow'
                    : 'Green')}] ${format.note(msg.time.toLocaleTimeString())} ${msg.message.trim()} ${msg.data ? this.safeJsonStringifyForDebug(msg.data) : ''}`, LogLevel.DEBUG);
        }
        return Promise.resolve();
    };
    amplifyNotifications = async (msg) => {
        if (msg.action !== 'amplify') {
            return;
        }
        switch (msg.code) {
            case 'TS_STARTED':
                this.printer.startSpinner('Running type checks...');
                return;
            case 'TS_FINISHED':
                this.printer.stopSpinner();
                break;
            case 'SYNTH_STARTED':
                this.printer.startSpinner('Synthesizing backend...');
                return;
            case 'SYNTH_FINISHED':
                this.printer.stopSpinner();
                break;
            case 'DEPLOY_STARTED':
                this.printer.stopSpinner();
                break;
            case 'AMPLIFY_CFN_PROGRESS_UPDATE':
                if (!this.printer.isSpinnerRunning()) {
                    this.printer.startSpinner('Deployment in progress...');
                }
                this.printer.updateSpinner({ prefixText: msg.message });
                return;
        }
        this.printer.log(msg.level === 'result'
            ? `${format.success('✔')} ${msg.message}`
            : msg.level === 'error'
                ? format.error(msg.message)
                : msg.message, msg.level === 'error' ? LogLevel.ERROR : LogLevel.INFO);
    };
    cdkDeploymentProgress = async (msg) => {
        // Asset publishing if any.
        if (msg.message.includes('Checking for previously published assets')) {
            if (!this.printer.isSpinnerRunning()) {
                this.printer.startSpinner('Building and publishing assets...');
            }
            return Promise.resolve();
        }
        // Hot swap deployment
        if (msg.code === 'CDK_TOOLKIT_I5403') {
            const hotswappedResources = this.extractResourceNameFromHotSwapMessage(msg.data);
            let message = msg.message;
            if (hotswappedResources && hotswappedResources.length > 0) {
                message = hotswappedResources
                    .map((resource) => `${format.success('✔')} Updated ${resource.resourceType} ${resource.resourceName}`)
                    .join(EOL);
            }
            if (this.printer.isSpinnerRunning()) {
                this.printer.stopSpinner();
                this.printer.log(message);
                this.printer.startSpinner('Deployment in progress...');
            }
            else {
                this.printer.log(message);
            }
        }
        // CFN Outputs we care about. CDK_TOOLKIT_I5900 code represents outputs message.
        // We save it so we can display at the end of the deployment.
        if (msg.code === 'CDK_TOOLKIT_I5900') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'outputs' in msg.data &&
                msg.data.outputs &&
                typeof msg.data.outputs === 'object') {
                this.outputs = msg.data.outputs;
            }
        }
        // Successful deployment or destruction with timing
        if (msg.code === 'CDK_TOOLKIT_I5000' || msg.code === 'CDK_TOOLKIT_I7000') {
            if (msg.data &&
                typeof msg.data === 'object' &&
                'duration' in msg.data &&
                msg.data.duration &&
                typeof msg.data.duration === 'number') {
                this.printer.log(`${format.success('✔')} Deployment completed in ${msg.data.duration / 1000} seconds`);
                if (this.outputs &&
                    'awsAppsyncApiEndpoint' in this.outputs &&
                    this.outputs.awsAppsyncApiEndpoint) {
                    this.printer.log(`AppSync API endpoint = ${format.link(this.outputs.awsAppsyncApiEndpoint)}`);
                }
            }
        }
    };
    /**
     * Displays pretty print of cfn deployment progress. Disabled if debug logging is turned on
     * @param msg a CDK event
     */
    fancyCfnDeploymentProgress = async (msg) => {
        // 5100 -> Deployment starts 7100 -> Destroy starts
        if ((msg.code === 'CDK_TOOLKIT_I5100' || msg.code === 'CDK_TOOLKIT_I7100') &&
            !this.cfnDeploymentProgressLogger) {
            if (msg.code === 'CDK_TOOLKIT_I5100') {
                // Mark assets published. We use "deploy started" as a cue to mark that all assets have been published
                await this.amplifyIOEventsBridgeSingletonFactory.getInstance().notify({
                    message: `Built and published assets`,
                    code: 'DEPLOY_STARTED',
                    action: 'amplify',
                    time: new Date(),
                    level: 'result',
                    data: undefined,
                });
            }
            // Start deployment progress display
            this.cfnDeploymentProgressLogger = this.getNewCfnDeploymentProgressLogger(this.printer);
            this.printer.startSpinner('Deployment in progress...', {
                timeoutSeconds: 300,
            });
        }
        // Stop deployment progress display
        // 5000 includes deployment time
        // 5503 is when the deployment is completed (not emitted for some updates but emitted for destroy and fails)
        // 5900 includes the stack outputs
        // 7900 is when the stack is destroyed
        if (msg.code === 'CDK_TOOLKIT_I5000' ||
            msg.code === 'CDK_TOOLKIT_I5503' ||
            msg.code === 'CDK_TOOLKIT_I5900' ||
            msg.code === 'CDK_TOOLKIT_I7900') {
            if (this.cfnDeploymentProgressLogger) {
                this.printer.stopSpinner();
                this.cfnDeploymentProgressLogger = undefined;
            }
        }
        // CFN Deployment progress events information
        if (msg.code === 'CDK_TOOLKIT_I5502' &&
            msg.data &&
            typeof msg.data === 'object' &&
            'event' in msg.data) {
            const event = msg.data;
            this.cfnDeploymentProgressLogger?.addActivity(event);
        }
        // CDK Marker that deployment is still in progress, we take this opportunity
        // to display the aggregated events
        if (msg.code === 'CDK_TOOLKIT_I0000' &&
            msg.message.includes('has an ongoing operation in progress')) {
            await this.cfnDeploymentProgressLogger?.print();
        }
        return Promise.resolve();
    };
    /**
     * Non fancy cfn deployment progress for ci/cd or files
     */
    nonTtyCfnDeploymentProgress = async (msg) => {
        if (msg.code === 'CDK_TOOLKIT_I5100') {
            await this.amplifyIOEventsBridgeSingletonFactory.getInstance().notify({
                message: `Built and published assets`,
                code: 'DEPLOY_STARTED',
                action: 'amplify',
                time: new Date(),
                level: 'result',
                data: undefined,
            });
        }
        if (msg.code === 'CDK_TOOLKIT_I5502') {
            // CDKs formatted cfn deployment progress
            this.printer.print(msg.message);
        }
    };
    getNewCfnDeploymentProgressLogger = (printer) => {
        const getBlockWidth = () => printer.stdout instanceof WriteStream ? printer.stdout.columns : 600;
        const getBlockHeight = () => printer.stdout instanceof WriteStream ? printer.stdout.rows : 100;
        return new CfnDeploymentProgressLogger({
            getBlockWidth,
            rewritableBlock: new RewritableBlock(getBlockWidth, getBlockHeight, this.amplifyIOEventsBridgeSingletonFactory.getInstance()),
        });
    };
    extractResourceNameFromHotSwapMessage = (data) => {
        if (data &&
            typeof data === 'object' &&
            'resources' in data &&
            Array.isArray(data.resources)) {
            return data.resources.map((resource) => {
                return {
                    resourceName: resource?.metadata?.constructPath ?? resource.logicalId,
                    resourceType: resource.resourceType,
                };
            });
        }
        return undefined;
    };
    safeJsonStringifyForDebug = (data) => {
        try {
            return JSON.stringify(data, null, 2);
        }
        catch {
            return 'Failed to deserialize data';
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1wbGlmeV9ldmVudF9sb2dnZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xvZ2dlcnMvYW1wbGlmeV9ldmVudF9sb2dnZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQVcsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsT0FBTyxJQUFJLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzdDLE9BQU8sRUFDTCwyQkFBMkIsR0FFNUIsTUFBTSw2REFBNkQsQ0FBQztBQUVyRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQztBQUVoRixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTlCOzs7R0FHRztBQUNILE1BQU0sT0FBTyxrQkFBa0I7SUFRVjtJQUNBO0lBUlgsMkJBQTJCLENBQTBDO0lBQ3JFLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFFckI7O09BRUc7SUFDSCxZQUNtQixVQUFtQixhQUFhLEVBQ2hDLHFDQUE0RTtRQUQ1RSxZQUFPLEdBQVAsT0FBTyxDQUF5QjtRQUNoQywwQ0FBcUMsR0FBckMscUNBQXFDLENBQXVDO0lBQzVGLENBQUM7SUFFSixlQUFlLEdBQUcsR0FBRyxFQUFFO1FBQ3JCLElBQUksZUFBZSxLQUFLLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN2QyxPQUFPO2dCQUNMLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDckIsQ0FBQztRQUNKLENBQUM7UUFDRCxNQUFNLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN4RSxJQUFJLElBQUks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LEVBQzdCLENBQUM7WUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUN2QixDQUFDLFFBSUEsRUFBRSxFQUFFO2dCQUNILE9BQU87b0JBQ0wsWUFBWSxFQUNWLFFBQVEsRUFBRSxRQUFRLEVBQUUsYUFBYSxJQUFJLFFBQVEsQ0FBQyxTQUFTO29CQUN6RCxZQUFZLEVBQUUsUUFBUSxDQUFDLFlBQVk7aUJBQ3BDLENBQUM7WUFDSixDQUFDLENBQ0YsQ0FBQztRQUNKLENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDLENBQUM7SUFFTSx5QkFBeUIsR0FBRyxDQUFDLElBQWEsRUFBRSxFQUFFO1FBQ3BELElBQUksQ0FBQztZQUNILE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7UUFBQyxNQUFNLENBQUM7WUFDUCxPQUFPLDRCQUE0QixDQUFDO1FBQ3RDLENBQUM7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvZ0xldmVsLCBQcmludGVyIH0gZnJvbSAnLi4vcHJpbnRlci9wcmludGVyLmpzJztcbmltcG9ydCB7IHByaW50ZXIgYXMgZ2xvYmFsUHJpbnRlciwgbWluaW11bUxvZ0xldmVsIH0gZnJvbSAnLi4vcHJpbnRlci5qcyc7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9mb3JtYXQvZm9ybWF0LmpzJztcbmltcG9ydCB7XG4gIENmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcixcbiAgQ2ZuRGVwbG95bWVudFN0YWNrRXZlbnQsXG59IGZyb20gJy4vY2ZuLWRlcGxveW1lbnQtcHJvZ3Jlc3MvY2ZuX2RlcGxveW1lbnRfcHJvZ3Jlc3NfbG9nZ2VyLmpzJztcbmltcG9ydCB7IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IFdyaXRlU3RyZWFtIH0gZnJvbSAnbm9kZTp0dHknO1xuaW1wb3J0IHsgUmV3cml0YWJsZUJsb2NrIH0gZnJvbSAnLi9jZm4tZGVwbG95bWVudC1wcm9ncmVzcy9yZXdyaXRhYmxlX2Jsb2NrLmpzJztcbmltcG9ydCB7IEFtcGxpZnlJT0V2ZW50c0JyaWRnZVNpbmdsZXRvbkZhY3RvcnkgfSBmcm9tICcuL2FtcGxpZnlfaW9fZXZlbnRzX2JyaWRnZV9zaW5nbGV0b25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdub2RlOm9zJztcblxuLyoqXG4gKiBBbXBsaWZ5IGV2ZW50cyBsb2dnZXIgY2xhc3MuIEltcGxlbWVudHMgc2V2ZXJhbCBsb2dnZXJzIHRoYXQgY29ubmVjdFxuICogdG8gdGhlIGFtcGxpZnlfaW9fZXZlbnRfYnJpZGdlIGZvciBzaG93aW5nIHJlbGV2YW50IGluZm9ybWF0aW9uIHRvIGN1c3RvbWVyc1xuICovXG5leHBvcnQgY2xhc3MgQW1wbGlmeUV2ZW50TG9nZ2VyIHtcbiAgcHJpdmF0ZSBjZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXI6IENmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlciB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBvdXRwdXRzID0ge307XG5cbiAgLyoqXG4gICAqIGEgbG9nZ2VyIGluc3RhbmNlIHRvIGJlIHVzZWQgZm9yIENESyBldmVudHNcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpbnRlcjogUHJpbnRlciA9IGdsb2JhbFByaW50ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBhbXBsaWZ5SU9FdmVudHNCcmlkZ2VTaW5nbGV0b25GYWN0b3J5OiBBbXBsaWZ5SU9FdmVudHNCcmlkZ2VTaW5nbGV0b25GYWN0b3J5LFxuICApIHt9XG5cbiAgZ2V0RXZlbnRMb2dnZXJzID0gKCkgPT4ge1xuICAgIGlmIChtaW5pbXVtTG9nTGV2ZWwgPT09IExvZ0xldmVsLkRFQlVHKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBub3RpZnk6IFt0aGlzLmRlYnVnXSxcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IGxvZ2dlcnMgPSBbdGhpcy5hbXBsaWZ5Tm90aWZpY2F0aW9ucywgdGhpcy5jZGtEZXBsb3ltZW50UHJvZ3Jlc3NdO1xuICAgIGlmICh0aGlzLnByaW50ZXIudHR5RW5hYmxlZCkge1xuICAgICAgbG9nZ2Vycy5wdXNoKHRoaXMuZmFuY3lDZm5EZXBsb3ltZW50UHJvZ3Jlc3MpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXJzLnB1c2godGhpcy5ub25UdHlDZm5EZXBsb3ltZW50UHJvZ3Jlc3MpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgbm90aWZ5OiBsb2dnZXJzLFxuICAgIH07XG4gIH07XG5cbiAgLyoqXG4gICAqIExvZyBkZWJ1ZyBtZXNzYWdlc1xuICAgKi9cbiAgZGVidWcgPSA8VD4obXNnOiBBbXBsaWZ5SW9Ib3N0RXZlbnRNZXNzYWdlPFQ+KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgaWYgKG1zZy5sZXZlbCA9PT0gJ3RyYWNlJyB8fCBtc2cubGV2ZWwgPT09ICdkZWJ1ZycpIHtcbiAgICAgIGlmIChcbiAgICAgICAgbXNnLmRhdGEgJiZcbiAgICAgICAgdHlwZW9mIG1zZy5kYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAnc2RrTGV2ZWwnIGluIG1zZy5kYXRhICYmXG4gICAgICAgICdjb250ZW50JyBpbiBtc2cuZGF0YSAmJlxuICAgICAgICBBcnJheS5pc0FycmF5KG1zZy5kYXRhLmNvbnRlbnQpXG4gICAgICApIHtcbiAgICAgICAgbXNnLmRhdGEuY29udGVudC5mb3JFYWNoKFxuICAgICAgICAgICh0cmFjZTogeyBjbGllbnROYW1lOiBzdHJpbmc7IGNvbW1hbmROYW1lOiBzdHJpbmcgfSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgICAgICAgYEFXUyBTREsgQ2FsbCAke3RyYWNlLmNsaWVudE5hbWV9OiAke3RyYWNlLmNvbW1hbmROYW1lfWAsXG4gICAgICAgICAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgICBgWyR7bXNnLmFjdGlvbn06ICR7bXNnLmNvZGV9XSAke21zZy5tZXNzYWdlfWAsXG4gICAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICAgIGBbJHtmb3JtYXQuY29sb3IoXG4gICAgICAgICAgYCR7bXNnLmFjdGlvbn06ICR7bXNnLmNvZGV9YCxcbiAgICAgICAgICBtc2cubGV2ZWwgPT09ICdlcnJvcidcbiAgICAgICAgICAgID8gJ1JlZCdcbiAgICAgICAgICAgIDogbXNnLmxldmVsID09PSAnd2FybidcbiAgICAgICAgICAgICAgPyAnWWVsbG93J1xuICAgICAgICAgICAgICA6ICdHcmVlbicsXG4gICAgICAgICl9XSAke2Zvcm1hdC5ub3RlKFxuICAgICAgICAgIG1zZy50aW1lLnRvTG9jYWxlVGltZVN0cmluZygpLFxuICAgICAgICApfSAke21zZy5tZXNzYWdlLnRyaW0oKX0gJHtcbiAgICAgICAgICBtc2cuZGF0YSA/IHRoaXMuc2FmZUpzb25TdHJpbmdpZnlGb3JEZWJ1Zyhtc2cuZGF0YSkgOiAnJ1xuICAgICAgICB9YCxcbiAgICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH07XG5cbiAgYW1wbGlmeU5vdGlmaWNhdGlvbnMgPSBhc3luYyA8VD4oXG4gICAgbXNnOiBBbXBsaWZ5SW9Ib3N0RXZlbnRNZXNzYWdlPFQ+LFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBpZiAobXNnLmFjdGlvbiAhPT0gJ2FtcGxpZnknKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHN3aXRjaCAobXNnLmNvZGUpIHtcbiAgICAgIGNhc2UgJ1RTX1NUQVJURUQnOlxuICAgICAgICB0aGlzLnByaW50ZXIuc3RhcnRTcGlubmVyKCdSdW5uaW5nIHR5cGUgY2hlY2tzLi4uJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgJ1RTX0ZJTklTSEVEJzpcbiAgICAgICAgdGhpcy5wcmludGVyLnN0b3BTcGlubmVyKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnU1lOVEhfU1RBUlRFRCc6XG4gICAgICAgIHRoaXMucHJpbnRlci5zdGFydFNwaW5uZXIoJ1N5bnRoZXNpemluZyBiYWNrZW5kLi4uJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIGNhc2UgJ1NZTlRIX0ZJTklTSEVEJzpcbiAgICAgICAgdGhpcy5wcmludGVyLnN0b3BTcGlubmVyKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnREVQTE9ZX1NUQVJURUQnOlxuICAgICAgICB0aGlzLnByaW50ZXIuc3RvcFNwaW5uZXIoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdBTVBMSUZZX0NGTl9QUk9HUkVTU19VUERBVEUnOlxuICAgICAgICBpZiAoIXRoaXMucHJpbnRlci5pc1NwaW5uZXJSdW5uaW5nKCkpIHtcbiAgICAgICAgICB0aGlzLnByaW50ZXIuc3RhcnRTcGlubmVyKCdEZXBsb3ltZW50IGluIHByb2dyZXNzLi4uJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcmludGVyLnVwZGF0ZVNwaW5uZXIoeyBwcmVmaXhUZXh0OiBtc2cubWVzc2FnZSB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgbXNnLmxldmVsID09PSAncmVzdWx0J1xuICAgICAgICA/IGAke2Zvcm1hdC5zdWNjZXNzKCfinJQnKX0gJHttc2cubWVzc2FnZX1gXG4gICAgICAgIDogbXNnLmxldmVsID09PSAnZXJyb3InXG4gICAgICAgICAgPyBmb3JtYXQuZXJyb3IobXNnLm1lc3NhZ2UpXG4gICAgICAgICAgOiBtc2cubWVzc2FnZSxcbiAgICAgIG1zZy5sZXZlbCA9PT0gJ2Vycm9yJyA/IExvZ0xldmVsLkVSUk9SIDogTG9nTGV2ZWwuSU5GTyxcbiAgICApO1xuICB9O1xuXG4gIGNka0RlcGxveW1lbnRQcm9ncmVzcyA9IGFzeW5jIDxUPihcbiAgICBtc2c6IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2U8VD4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIC8vIEFzc2V0IHB1Ymxpc2hpbmcgaWYgYW55LlxuICAgIGlmIChtc2cubWVzc2FnZS5pbmNsdWRlcygnQ2hlY2tpbmcgZm9yIHByZXZpb3VzbHkgcHVibGlzaGVkIGFzc2V0cycpKSB7XG4gICAgICBpZiAoIXRoaXMucHJpbnRlci5pc1NwaW5uZXJSdW5uaW5nKCkpIHtcbiAgICAgICAgdGhpcy5wcmludGVyLnN0YXJ0U3Bpbm5lcignQnVpbGRpbmcgYW5kIHB1Ymxpc2hpbmcgYXNzZXRzLi4uJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgLy8gSG90IHN3YXAgZGVwbG95bWVudFxuICAgIGlmIChtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1NDAzJykge1xuICAgICAgY29uc3QgaG90c3dhcHBlZFJlc291cmNlcyA9IHRoaXMuZXh0cmFjdFJlc291cmNlTmFtZUZyb21Ib3RTd2FwTWVzc2FnZShcbiAgICAgICAgbXNnLmRhdGEsXG4gICAgICApO1xuICAgICAgbGV0IG1lc3NhZ2UgPSBtc2cubWVzc2FnZTtcbiAgICAgIGlmIChob3Rzd2FwcGVkUmVzb3VyY2VzICYmIGhvdHN3YXBwZWRSZXNvdXJjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBtZXNzYWdlID0gaG90c3dhcHBlZFJlc291cmNlc1xuICAgICAgICAgIC5tYXAoXG4gICAgICAgICAgICAocmVzb3VyY2UpID0+XG4gICAgICAgICAgICAgIGAke2Zvcm1hdC5zdWNjZXNzKCfinJQnKX0gVXBkYXRlZCAke3Jlc291cmNlLnJlc291cmNlVHlwZX0gJHtyZXNvdXJjZS5yZXNvdXJjZU5hbWV9YCxcbiAgICAgICAgICApXG4gICAgICAgICAgLmpvaW4oRU9MKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnByaW50ZXIuaXNTcGlubmVyUnVubmluZygpKSB7XG4gICAgICAgIHRoaXMucHJpbnRlci5zdG9wU3Bpbm5lcigpO1xuICAgICAgICB0aGlzLnByaW50ZXIubG9nKG1lc3NhZ2UpO1xuICAgICAgICB0aGlzLnByaW50ZXIuc3RhcnRTcGlubmVyKCdEZXBsb3ltZW50IGluIHByb2dyZXNzLi4uJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnByaW50ZXIubG9nKG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENGTiBPdXRwdXRzIHdlIGNhcmUgYWJvdXQuIENES19UT09MS0lUX0k1OTAwIGNvZGUgcmVwcmVzZW50cyBvdXRwdXRzIG1lc3NhZ2UuXG4gICAgLy8gV2Ugc2F2ZSBpdCBzbyB3ZSBjYW4gZGlzcGxheSBhdCB0aGUgZW5kIG9mIHRoZSBkZXBsb3ltZW50LlxuICAgIGlmIChtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1OTAwJykge1xuICAgICAgaWYgKFxuICAgICAgICBtc2cuZGF0YSAmJlxuICAgICAgICB0eXBlb2YgbXNnLmRhdGEgPT09ICdvYmplY3QnICYmXG4gICAgICAgICdvdXRwdXRzJyBpbiBtc2cuZGF0YSAmJlxuICAgICAgICBtc2cuZGF0YS5vdXRwdXRzICYmXG4gICAgICAgIHR5cGVvZiBtc2cuZGF0YS5vdXRwdXRzID09PSAnb2JqZWN0J1xuICAgICAgKSB7XG4gICAgICAgIHRoaXMub3V0cHV0cyA9IG1zZy5kYXRhLm91dHB1dHM7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3VjY2Vzc2Z1bCBkZXBsb3ltZW50IG9yIGRlc3RydWN0aW9uIHdpdGggdGltaW5nXG4gICAgaWYgKG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTUwMDAnIHx8IG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTcwMDAnKSB7XG4gICAgICBpZiAoXG4gICAgICAgIG1zZy5kYXRhICYmXG4gICAgICAgIHR5cGVvZiBtc2cuZGF0YSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgJ2R1cmF0aW9uJyBpbiBtc2cuZGF0YSAmJlxuICAgICAgICBtc2cuZGF0YS5kdXJhdGlvbiAmJlxuICAgICAgICB0eXBlb2YgbXNnLmRhdGEuZHVyYXRpb24gPT09ICdudW1iZXInXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5wcmludGVyLmxvZyhcbiAgICAgICAgICBgJHtmb3JtYXQuc3VjY2Vzcygn4pyUJyl9IERlcGxveW1lbnQgY29tcGxldGVkIGluICR7XG4gICAgICAgICAgICBtc2cuZGF0YS5kdXJhdGlvbiAvIDEwMDBcbiAgICAgICAgICB9IHNlY29uZHNgLFxuICAgICAgICApO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdGhpcy5vdXRwdXRzICYmXG4gICAgICAgICAgJ2F3c0FwcHN5bmNBcGlFbmRwb2ludCcgaW4gdGhpcy5vdXRwdXRzICYmXG4gICAgICAgICAgdGhpcy5vdXRwdXRzLmF3c0FwcHN5bmNBcGlFbmRwb2ludFxuICAgICAgICApIHtcbiAgICAgICAgICB0aGlzLnByaW50ZXIubG9nKFxuICAgICAgICAgICAgYEFwcFN5bmMgQVBJIGVuZHBvaW50ID0gJHtmb3JtYXQubGluayhcbiAgICAgICAgICAgICAgdGhpcy5vdXRwdXRzLmF3c0FwcHN5bmNBcGlFbmRwb2ludCBhcyBzdHJpbmcsXG4gICAgICAgICAgICApfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogRGlzcGxheXMgcHJldHR5IHByaW50IG9mIGNmbiBkZXBsb3ltZW50IHByb2dyZXNzLiBEaXNhYmxlZCBpZiBkZWJ1ZyBsb2dnaW5nIGlzIHR1cm5lZCBvblxuICAgKiBAcGFyYW0gbXNnIGEgQ0RLIGV2ZW50XG4gICAqL1xuICBmYW5jeUNmbkRlcGxveW1lbnRQcm9ncmVzcyA9IGFzeW5jIDxUPihcbiAgICBtc2c6IEFtcGxpZnlJb0hvc3RFdmVudE1lc3NhZ2U8VD4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIC8vIDUxMDAgLT4gRGVwbG95bWVudCBzdGFydHMgNzEwMCAtPiBEZXN0cm95IHN0YXJ0c1xuICAgIGlmIChcbiAgICAgIChtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1MTAwJyB8fCBtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k3MTAwJykgJiZcbiAgICAgICF0aGlzLmNmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlclxuICAgICkge1xuICAgICAgaWYgKG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTUxMDAnKSB7XG4gICAgICAgIC8vIE1hcmsgYXNzZXRzIHB1Ymxpc2hlZC4gV2UgdXNlIFwiZGVwbG95IHN0YXJ0ZWRcIiBhcyBhIGN1ZSB0byBtYXJrIHRoYXQgYWxsIGFzc2V0cyBoYXZlIGJlZW4gcHVibGlzaGVkXG4gICAgICAgIGF3YWl0IHRoaXMuYW1wbGlmeUlPRXZlbnRzQnJpZGdlU2luZ2xldG9uRmFjdG9yeS5nZXRJbnN0YW5jZSgpLm5vdGlmeSh7XG4gICAgICAgICAgbWVzc2FnZTogYEJ1aWx0IGFuZCBwdWJsaXNoZWQgYXNzZXRzYCxcbiAgICAgICAgICBjb2RlOiAnREVQTE9ZX1NUQVJURUQnLFxuICAgICAgICAgIGFjdGlvbjogJ2FtcGxpZnknLFxuICAgICAgICAgIHRpbWU6IG5ldyBEYXRlKCksXG4gICAgICAgICAgbGV2ZWw6ICdyZXN1bHQnLFxuICAgICAgICAgIGRhdGE6IHVuZGVmaW5lZCxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFN0YXJ0IGRlcGxveW1lbnQgcHJvZ3Jlc3MgZGlzcGxheVxuICAgICAgdGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIgPSB0aGlzLmdldE5ld0NmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcihcbiAgICAgICAgdGhpcy5wcmludGVyLFxuICAgICAgKTtcbiAgICAgIHRoaXMucHJpbnRlci5zdGFydFNwaW5uZXIoJ0RlcGxveW1lbnQgaW4gcHJvZ3Jlc3MuLi4nLCB7XG4gICAgICAgIHRpbWVvdXRTZWNvbmRzOiAzMDAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTdG9wIGRlcGxveW1lbnQgcHJvZ3Jlc3MgZGlzcGxheVxuICAgIC8vIDUwMDAgaW5jbHVkZXMgZGVwbG95bWVudCB0aW1lXG4gICAgLy8gNTUwMyBpcyB3aGVuIHRoZSBkZXBsb3ltZW50IGlzIGNvbXBsZXRlZCAobm90IGVtaXR0ZWQgZm9yIHNvbWUgdXBkYXRlcyBidXQgZW1pdHRlZCBmb3IgZGVzdHJveSBhbmQgZmFpbHMpXG4gICAgLy8gNTkwMCBpbmNsdWRlcyB0aGUgc3RhY2sgb3V0cHV0c1xuICAgIC8vIDc5MDAgaXMgd2hlbiB0aGUgc3RhY2sgaXMgZGVzdHJveWVkXG4gICAgaWYgKFxuICAgICAgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTAwMCcgfHxcbiAgICAgIG1zZy5jb2RlID09PSAnQ0RLX1RPT0xLSVRfSTU1MDMnIHx8XG4gICAgICBtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0k1OTAwJyB8fFxuICAgICAgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNzkwMCdcbiAgICApIHtcbiAgICAgIGlmICh0aGlzLmNmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcikge1xuICAgICAgICB0aGlzLnByaW50ZXIuc3RvcFNwaW5uZXIoKTtcbiAgICAgICAgdGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXIgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ0ZOIERlcGxveW1lbnQgcHJvZ3Jlc3MgZXZlbnRzIGluZm9ybWF0aW9uXG4gICAgaWYgKFxuICAgICAgbXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTUwMicgJiZcbiAgICAgIG1zZy5kYXRhICYmXG4gICAgICB0eXBlb2YgbXNnLmRhdGEgPT09ICdvYmplY3QnICYmXG4gICAgICAnZXZlbnQnIGluIG1zZy5kYXRhXG4gICAgKSB7XG4gICAgICBjb25zdCBldmVudCA9IG1zZy5kYXRhIGFzIENmbkRlcGxveW1lbnRTdGFja0V2ZW50O1xuICAgICAgdGhpcy5jZm5EZXBsb3ltZW50UHJvZ3Jlc3NMb2dnZXI/LmFkZEFjdGl2aXR5KGV2ZW50KTtcbiAgICB9XG5cbiAgICAvLyBDREsgTWFya2VyIHRoYXQgZGVwbG95bWVudCBpcyBzdGlsbCBpbiBwcm9ncmVzcywgd2UgdGFrZSB0aGlzIG9wcG9ydHVuaXR5XG4gICAgLy8gdG8gZGlzcGxheSB0aGUgYWdncmVnYXRlZCBldmVudHNcbiAgICBpZiAoXG4gICAgICBtc2cuY29kZSA9PT0gJ0NES19UT09MS0lUX0kwMDAwJyAmJlxuICAgICAgbXNnLm1lc3NhZ2UuaW5jbHVkZXMoJ2hhcyBhbiBvbmdvaW5nIG9wZXJhdGlvbiBpbiBwcm9ncmVzcycpXG4gICAgKSB7XG4gICAgICBhd2FpdCB0aGlzLmNmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcj8ucHJpbnQoKTtcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBOb24gZmFuY3kgY2ZuIGRlcGxveW1lbnQgcHJvZ3Jlc3MgZm9yIGNpL2NkIG9yIGZpbGVzXG4gICAqL1xuICBub25UdHlDZm5EZXBsb3ltZW50UHJvZ3Jlc3MgPSBhc3luYyA8VD4oXG4gICAgbXNnOiBBbXBsaWZ5SW9Ib3N0RXZlbnRNZXNzYWdlPFQ+LFxuICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBpZiAobXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTEwMCcpIHtcbiAgICAgIGF3YWl0IHRoaXMuYW1wbGlmeUlPRXZlbnRzQnJpZGdlU2luZ2xldG9uRmFjdG9yeS5nZXRJbnN0YW5jZSgpLm5vdGlmeSh7XG4gICAgICAgIG1lc3NhZ2U6IGBCdWlsdCBhbmQgcHVibGlzaGVkIGFzc2V0c2AsXG4gICAgICAgIGNvZGU6ICdERVBMT1lfU1RBUlRFRCcsXG4gICAgICAgIGFjdGlvbjogJ2FtcGxpZnknLFxuICAgICAgICB0aW1lOiBuZXcgRGF0ZSgpLFxuICAgICAgICBsZXZlbDogJ3Jlc3VsdCcsXG4gICAgICAgIGRhdGE6IHVuZGVmaW5lZCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAobXNnLmNvZGUgPT09ICdDREtfVE9PTEtJVF9JNTUwMicpIHtcbiAgICAgIC8vIENES3MgZm9ybWF0dGVkIGNmbiBkZXBsb3ltZW50IHByb2dyZXNzXG4gICAgICB0aGlzLnByaW50ZXIucHJpbnQobXNnLm1lc3NhZ2UpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGdldE5ld0NmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlciA9IChwcmludGVyOiBQcmludGVyKSA9PiB7XG4gICAgY29uc3QgZ2V0QmxvY2tXaWR0aCA9ICgpID0+XG4gICAgICBwcmludGVyLnN0ZG91dCBpbnN0YW5jZW9mIFdyaXRlU3RyZWFtID8gcHJpbnRlci5zdGRvdXQuY29sdW1ucyA6IDYwMDtcbiAgICBjb25zdCBnZXRCbG9ja0hlaWdodCA9ICgpID0+XG4gICAgICBwcmludGVyLnN0ZG91dCBpbnN0YW5jZW9mIFdyaXRlU3RyZWFtID8gcHJpbnRlci5zdGRvdXQucm93cyA6IDEwMDtcbiAgICByZXR1cm4gbmV3IENmbkRlcGxveW1lbnRQcm9ncmVzc0xvZ2dlcih7XG4gICAgICBnZXRCbG9ja1dpZHRoLFxuICAgICAgcmV3cml0YWJsZUJsb2NrOiBuZXcgUmV3cml0YWJsZUJsb2NrKFxuICAgICAgICBnZXRCbG9ja1dpZHRoLFxuICAgICAgICBnZXRCbG9ja0hlaWdodCxcbiAgICAgICAgdGhpcy5hbXBsaWZ5SU9FdmVudHNCcmlkZ2VTaW5nbGV0b25GYWN0b3J5LmdldEluc3RhbmNlKCksXG4gICAgICApLFxuICAgIH0pO1xuICB9O1xuXG4gIHByaXZhdGUgZXh0cmFjdFJlc291cmNlTmFtZUZyb21Ib3RTd2FwTWVzc2FnZSA9IChcbiAgICBkYXRhOiB1bmtub3duLFxuICApOiB7IHJlc291cmNlVHlwZTogc3RyaW5nOyByZXNvdXJjZU5hbWU6IHN0cmluZyB9W10gfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChcbiAgICAgIGRhdGEgJiZcbiAgICAgIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJlxuICAgICAgJ3Jlc291cmNlcycgaW4gZGF0YSAmJlxuICAgICAgQXJyYXkuaXNBcnJheShkYXRhLnJlc291cmNlcylcbiAgICApIHtcbiAgICAgIHJldHVybiBkYXRhLnJlc291cmNlcy5tYXAoXG4gICAgICAgIChyZXNvdXJjZToge1xuICAgICAgICAgIGxvZ2ljYWxJZDogc3RyaW5nO1xuICAgICAgICAgIHJlc291cmNlVHlwZTogc3RyaW5nO1xuICAgICAgICAgIG1ldGFkYXRhPzogeyBjb25zdHJ1Y3RQYXRoPzogc3RyaW5nIH07XG4gICAgICAgIH0pID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVzb3VyY2VOYW1lOlxuICAgICAgICAgICAgICByZXNvdXJjZT8ubWV0YWRhdGE/LmNvbnN0cnVjdFBhdGggPz8gcmVzb3VyY2UubG9naWNhbElkLFxuICAgICAgICAgICAgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5yZXNvdXJjZVR5cGUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgcHJpdmF0ZSBzYWZlSnNvblN0cmluZ2lmeUZvckRlYnVnID0gKGRhdGE6IHVua25vd24pID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGRhdGEsIG51bGwsIDIpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuICdGYWlsZWQgdG8gZGVzZXJpYWxpemUgZGF0YSc7XG4gICAgfVxuICB9O1xufVxuIl19